CKEDITOR.dialog.add("base64imageDialog",function(e){function t(){var e=!1,t=null;try{if(FileReader){var t=document.createElement("input");t&&"files"in t&&(e=!0)}}catch(n){e=!1}return t=null,e}function n(t){if("string"!=typeof t||!t)return void u.getElement().setHtml("");var n=new Image;u.getElement().setHtml("Loading..."),n.onload=function(){u.getElement().setHtml(""),null==g||null==p?(o.setValueOf("tab-properties","width",this.width),o.setValueOf("tab-properties","height",this.height),b=1,this.height>0&&this.width>0&&(b=this.width/this.height),0>=b&&(b=1)):(g=null,p=null),this.id=e.id+"previewimage",this.setAttribute("style","max-width:400px;max-height:100px;"),this.setAttribute("alt","");try{var t=u.getElement().$;t&&t.appendChild(this)}catch(n){}},n.onerror=function(){u.getElement().setHtml("")},n.onabort=function(){u.getElement().setHtml("")},n.src=t}function i(e){if(u.getElement().setHtml(""),"base64"==e)h&&h.setValue(!1,!0),c&&c.setValue(!1,!0);else if("url"==e)h&&h.setValue(!0,!0),c&&c.setValue(!1,!0),m&&n(m.getValue());else if(f){h&&h.setValue(!1,!0),c&&c.setValue(!0,!0);var t=o.getContentElement("tab-source","file"),i=null;try{i=t.getInputElement().$}catch(l){i=null}if(i&&"files"in i&&i.files&&i.files.length>0&&i.files[0]){if("type"in i.files[0]&&!i.files[0].type.match("image.*"))return;if(!FileReader)return;u.getElement().setHtml("Loading...");var a=new FileReader;a.onload=function(e){return function(e){u.getElement().setHtml("");var t=new FormData;t.append("image",i.files[0]),$.ajax({url:"/admin/pagina/guardarImagenCKeditor",type:"POST",contentType:!1,data:t,processData:!1,cache:!1}).done(function(e){n(e)})}}(i.files[0]),a.onerror=function(){u.getElement().setHtml("")},a.onabort=function(){u.getElement().setHtml("")},a.readAsDataURL(i.files[0])}}}function l(){var e={w:o.getContentElement("tab-properties","width").getValue(),h:o.getContentElement("tab-properties","height").getValue(),uw:"px",uh:"px"};return e.w.indexOf("%")>=0&&(e.uw="%"),e.h.indexOf("%")>=0&&(e.uh="%"),e.w=parseInt(e.w,10),e.h=parseInt(e.h,10),isNaN(e.w)&&(e.w=0),isNaN(e.h)&&(e.h=0),e}function a(e){var t=l(),n="px";"width"==e?("%"==t.uw&&(n="%"),t.h=Math.round(t.w/b)):("%"==t.uh&&(n="%"),t.w=Math.round(t.h*b)),"%"==n&&(t.w+="%",t.h+="%"),o.getContentElement("tab-properties","width").setValue(t.w),o.getContentElement("tab-properties","height").setValue(t.h)}function r(e){var t=e.getValue(),n="";t.indexOf("%")>=0&&(n="%"),t=parseInt(t,10),isNaN(t)&&(t=0),e.setValue(t+n)}var o=null,s=null,g=null,p=null,u=null,h=null,m=null,c=null,b=1,d=!0,f=t();if(f)var w=[{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"urlcheckbox",style:"margin-top:5px",label:e.lang.common.url+":"},{type:"text",id:"url",label:"",onChange:function(){i("url")}}]},{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"filecheckbox",style:"margin-top:5px",label:e.lang.common.upload+":"},{type:"file",id:"file",label:"",onChange:function(){i("file")}}]},{type:"html",id:"preview",html:new CKEDITOR.template('<div style="text-align:center;"></div>').output()}];else var w=[{type:"text",id:"url",label:e.lang.common.url,onChange:function(){i("url")}},{type:"html",id:"preview",html:new CKEDITOR.template('<div style="text-align:center;"></div>').output()}];return{title:e.lang.common.image,minWidth:450,minHeight:180,onLoad:function(){f&&(h=this.getContentElement("tab-source","urlcheckbox"),c=this.getContentElement("tab-source","filecheckbox"),h.getInputElement().on("click",function(){i("url")}),c.getInputElement().on("click",function(){i("file")})),m=this.getContentElement("tab-source","url"),u=this.getContentElement("tab-source","preview"),this.getContentElement("tab-properties","lock").getInputElement().on("click",function(){d=this.getValue()?!0:!1,d&&a("width")},this.getContentElement("tab-properties","lock")),this.getContentElement("tab-properties","width").getInputElement().on("keyup",function(){d&&a("width")}),this.getContentElement("tab-properties","height").getInputElement().on("keyup",function(){d&&a("height")}),this.getContentElement("tab-properties","vmargin").getInputElement().on("keyup",function(){r(this)},this.getContentElement("tab-properties","vmargin")),this.getContentElement("tab-properties","hmargin").getInputElement().on("keyup",function(){r(this)},this.getContentElement("tab-properties","hmargin")),this.getContentElement("tab-properties","border").getInputElement().on("keyup",function(){r(this)},this.getContentElement("tab-properties","border"))},onShow:function(){if(u.getElement().setHtml(""),o=this,g=null,p=null,b=1,d=!0,s=e.getSelection(),s&&(s=s.getSelectedElement()),s&&"img"===s.getName()||(s=null),o.setValueOf("tab-properties","lock",d),o.setValueOf("tab-properties","vmargin","0"),o.setValueOf("tab-properties","hmargin","0"),o.setValueOf("tab-properties","border","0"),o.setValueOf("tab-properties","align","none"),s){if("string"==typeof s.getAttribute("width")&&(g=s.getAttribute("width")),"string"==typeof s.getAttribute("height")&&(p=s.getAttribute("height")),null!=g&&null!=p||!s.$||(g=s.$.width,p=s.$.height),null!=g&&null!=p&&(o.setValueOf("tab-properties","width",g),o.setValueOf("tab-properties","height",p),g=parseInt(g,10),p=parseInt(p,10),b=1,!isNaN(g)&&!isNaN(p)&&p>0&&g>0&&(b=g/p),0>=b&&(b=1)),"string"==typeof s.getAttribute("src")&&(0===s.getAttribute("src").indexOf("data:")?(i("base64"),n(s.getAttribute("src"))):o.setValueOf("tab-source","url",s.getAttribute("src"))),"string"==typeof s.getAttribute("alt")&&o.setValueOf("tab-properties","alt",s.getAttribute("alt")),"string"==typeof s.getAttribute("hspace")&&o.setValueOf("tab-properties","hmargin",s.getAttribute("hspace")),"string"==typeof s.getAttribute("vspace")&&o.setValueOf("tab-properties","vmargin",s.getAttribute("vspace")),"string"==typeof s.getAttribute("border")&&o.setValueOf("tab-properties","border",s.getAttribute("border")),"string"==typeof s.getAttribute("align"))switch(s.getAttribute("align")){case"top":case"text-top":o.setValueOf("tab-properties","align","top");break;case"baseline":case"bottom":case"text-bottom":o.setValueOf("tab-properties","align","bottom");break;case"left":o.setValueOf("tab-properties","align","left");break;case"right":o.setValueOf("tab-properties","align","right")}o.selectPage("tab-properties")}},onOk:function(){var t="";try{t=CKEDITOR.document.getById(e.id+"previewimage").$.src}catch(n){t=""}if("string"==typeof t&&null!=t&&""!==t){if(s)var i=s;else var i=e.document.createElement("img");i.setAttribute("src",t),t=null,i.setAttribute("alt",o.getValueOf("tab-properties","alt").replace(/^\s+/,"").replace(/\s+$/,""));var l,a,r,g,p={width:["width","width:#;","integer",1],height:["height","height:#;","integer",1],vmargin:["vspace","margin-top:#;margin-bottom:#;","integer",0],hmargin:["hspace","margin-left:#;margin-right:#;","integer",0],align:["align",""],border:["border","border:# solid black;","integer",0]},u=[];for(g in p){if(l=o.getValueOf("tab-properties",g),r=l,a=l,unit="px","align"==g)switch(l){case"top":case"bottom":p[g][1]="vertical-align:#;";break;case"left":case"right":p[g][1]="float:#;";break;default:l=null}"integer"==p[g][2]&&(l.indexOf("%")>=0&&(unit="%"),l=parseInt(l,10),isNaN(l)?l=null:l<p[g][3]&&(l=null),null!=l&&("%"==unit?(r=l+"%",a=l+"%"):(r=l,a=l+"px"))),null!=l&&(i.setAttribute(p[g][0],r),u.push(p[g][1].replace(/#/g,a)))}u.length>0&&i.setAttribute("style",u.join("")),s||e.insertElement(i),e.plugins.imageresize&&e.plugins.imageresize.resize(e,i,800,800)}},contents:[{id:"tab-source",label:e.lang.common.generalTab,elements:w},{id:"tab-properties",label:e.lang.common.advancedTab,elements:[{type:"text",id:"alt",label:e.lang.base64image.alt},{type:"hbox",widths:["15%","15%","70%"],children:[{type:"text",width:"45px",id:"width",label:e.lang.common.width},{type:"text",width:"45px",id:"height",label:e.lang.common.height},{type:"checkbox",id:"lock",label:e.lang.base64image.lockRatio,style:"margin-top:18px;"}]},{type:"hbox",widths:["23%","30%","30%","17%"],style:"margin-top:10px;",children:[{type:"select",id:"align",label:e.lang.common.align,items:[[e.lang.common.notSet,"none"],[e.lang.common.alignTop,"top"],[e.lang.common.alignBottom,"bottom"],[e.lang.common.alignLeft,"left"],[e.lang.common.alignRight,"right"]]},{type:"text",width:"45px",id:"vmargin",label:e.lang.base64image.vSpace},{type:"text",width:"45px",id:"hmargin",label:e.lang.base64image.hSpace},{type:"text",width:"45px",id:"border",label:e.lang.base64image.border}]}]}]}});